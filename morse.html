<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Morse Decoder — The Upside Protocol</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

  <div id="timer">⏱ --:--</div>

  <div class="container">

    <p class="stage-label">// MORSE TRANSMISSION UNIT — TASK 4 //</p>

    <h2>INCOMING TRANSMISSION</h2>

    <hr class="divider" />

    <!-- Cheat sheet notice -->
    <div class="physical-note" style="text-align:center;">
      <p style="color:#cc4444; font-size:.88rem; letter-spacing:2px;">
        ⚠ A MORSE CODE REFERENCE SHEET IS HIDDEN SOMEWHERE IN THE ROOM.<br>
        LOCATE IT BEFORE ATTEMPTING TO DECODE THE TRANSMISSION.
      </p>
    </div>

    <hr class="divider" />

    <!-- Morse audio player -->
    <div style="display:flex; flex-direction:column; align-items:center; gap:12px; width:100%;">
      <p style="font-size:.8rem; letter-spacing:2px; color:#661111;">
        &gt; INTERCEPT AUDIO TRANSMISSION
      </p>
      <button id="playBtn" onclick="playMorse()">▶ PLAY TRANSMISSION</button>
      <p id="playStatus" class="msg" style="font-size:.78rem; letter-spacing:2px; min-height:18px;"></p>
    </div>

    <hr class="divider" />

    <div class="input-group">
      <input
        type="text"
        id="answerMorse"
        placeholder="ENTER DECODED PASSWORD"
        autocomplete="off"
        spellcheck="false"
      />
      <button
        class="verify-btn"
        onclick="checkAnswer('answerMorse', 'msgMorse', 'KINGSTEVE123', onMorseCorrect)"
      >
        VERIFY
      </button>
    </div>

    <span id="msgMorse" class="msg"></span>

    <!-- Shown after correct answer -->
    <div id="laptopSection" style="display:none">
      <hr class="divider" />
      <div class="physical-note">
        <p>✔ TRANSMISSION DECODED</p>
        <p>Proceed to the next step.</p>
      </div>
      <button style="margin-top:16px" onclick="confirmLaptop()">
        CONFIRM LAPTOP ACCESSED
      </button>
    </div>

  </div>

  <script src="script.js"></script>
  <script>
    /* ── Morse Audio (Web Audio API) ─────────────── */
    // MAIN GATE in Morse: -- .- .. -. / --. .- - .
    // Each entry: [isOn, durationInUnits]
    // unit = 100ms | dot=1 | dash=3 | elem-gap=1 | letter-gap=3 | word-gap=7
    var MORSE_SEQUENCE = (function () {
      var syms = {
        K: [[1,3],[0,1],[1,1],[0,1],[1,3]],
        I: [[1,1],[0,1],[1,1]],
        N: [[1,3],[0,1],[1,1]],
        G: [[1,3],[0,1],[1,3],[0,1],[1,1]],
        S: [[1,1],[0,1],[1,1],[0,1],[1,1]],
        T: [[1,3]],
        E: [[1,1]],
        V: [[1,1],[0,1],[1,1],[0,1],[1,1],[0,1],[1,3]],
        "1": [[1,1],[0,1],[1,3],[0,1],[1,3],[0,1],[1,3],[0,1],[1,3]],
        "2": [[1,1],[0,1],[1,1],[0,1],[1,3],[0,1],[1,3],[0,1],[1,3]],
        "3": [[1,1],[0,1],[1,1],[0,1],[1,1],[0,1],[1,3],[0,1],[1,3]]
      };
      var word = "KINGSTEVE123";
      var seq  = [];
      word.split("").forEach(function (ch, ci) {
        syms[ch].forEach(function (s) { seq.push(s); });
        if (ci < word.length - 1) seq.push([0, 3]);
      });
      return seq;
    })();

    var morseCtx  = null;
    var morsePlaying = false;

    function playMorse() {
      if (morsePlaying) return;
      var ACtx = window.AudioContext || window.webkitAudioContext;
      if (!ACtx) {
        document.getElementById("playStatus").textContent = "⚠ AUDIO NOT SUPPORTED";
        return;
      }

      morseCtx    = new ACtx();
      morsePlaying = true;
      var btn     = document.getElementById("playBtn");
      var status  = document.getElementById("playStatus");
      btn.textContent    = "◼ TRANSMITTING...";
      btn.disabled       = true;
      status.textContent = "▶ SIGNAL ACTIVE";
      status.className   = "msg success";

      var unit  = 0.20;   // seconds per unit (0.5x speed)
      var freq  = 650;    // Hz tone
      var t     = morseCtx.currentTime + 0.05;
      var total = 0;

      MORSE_SEQUENCE.forEach(function (pair) {
        var on  = pair[0];
        var dur = pair[1] * unit;
        if (on) {
          var osc  = morseCtx.createOscillator();
          var gain = morseCtx.createGain();
          osc.connect(gain);
          gain.connect(morseCtx.destination);
          osc.type            = "sine";
          osc.frequency.value = freq;
          gain.gain.setValueAtTime(0, t);
          gain.gain.linearRampToValueAtTime(0.5, t + 0.005);
          gain.gain.setValueAtTime(0.5, t + dur - 0.005);
          gain.gain.linearRampToValueAtTime(0, t + dur);
          osc.start(t);
          osc.stop(t + dur + 0.01);
        }
        t     += dur;
        total += dur;
      });

      // Re-enable button after playback finishes
      setTimeout(function () {
        btn.textContent    = "▶ PLAY TRANSMISSION";
        btn.disabled       = false;
        status.textContent = "✔ TRANSMISSION COMPLETE";
        morsePlaying       = false;
        morseCtx.close();
      }, (total + 0.3) * 1000);
    }

    /* ── Page logic ─────────────────────────────── */
    function onMorseCorrect() {
      markStep(4);
      document.getElementById("laptopSection").style.display = "block";
    }

    function confirmLaptop() {
      window.location.href = "breach.html";
    }
  </script>

</body>
</html>
